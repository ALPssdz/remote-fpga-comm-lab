<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPGA Remote Lab v8.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyber-black': '#050505',
                        'cyber-gray': '#121212',
                        'cyber-blue': '#00f3ff',
                        'cyber-orange': '#ffaa00',
                        'cyber-green': '#00ff41',
                        'cyber-red': '#ff2a2a',
                        'cyber-yellow': '#ffd700',
                        'cyber-purple': '#bc13fe',
                    },
                    fontFamily: { mono: ['"JetBrains Mono"', 'Consolas', 'monospace'] },
                    animation: { 
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e2e8f0; }
        .glass-panel {
            background: rgba(20, 25, 35, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .glass-modal {
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
        }
        .btn-glow:hover { box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); border-color: #00f3ff; color: #fff; }
        .fpga-card-selected { border-color: #00f3ff; background: rgba(0, 243, 255, 0.1); }
        .fpga-card:hover { border-color: #666; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #e2e8f0; cursor: pointer; margin-top: -6px; border: 2px solid #333;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        input[type=range]:focus::-webkit-slider-thumb { background: #00f3ff; border-color: #fff; box-shadow: 0 0 10px #00f3ff; }
        
        #trigSlider::-webkit-slider-thumb { border-color: #ffd700; background: #ffd700; }
        #trigSlider:focus::-webkit-slider-thumb { box-shadow: 0 0 10px #ffd700; }

        .knob-label { font-size: 10px; color: #888; font-family: monospace; text-align: center; margin-top: 4px; }
        .hidden-ctrl { display: none !important; }
        .progress-bar { transition: width 0.1s linear; }

        /* AI Chat Styles */
        .ai-msg { align-self: flex-start; background: rgba(0, 243, 255, 0.1); border: 1px solid rgba(0, 243, 255, 0.3); color: #e2e8f0; border-radius: 12px 12px 12px 0; }
        .user-msg { align-self: flex-end; background: rgba(188, 19, 254, 0.2); border: 1px solid rgba(188, 19, 254, 0.4); color: white; border-radius: 12px 12px 0 12px; }
        .typing-dot { width: 6px; height: 6px; background: #00f3ff; border-radius: 50%; animation: pulse 1s infinite; display: inline-block; margin: 0 2px; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Markdown & Math Typography */
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body strong { color: #00f3ff; font-weight: bold; }
        .markdown-body code { font-family: 'JetBrains Mono', monospace; background: rgba(0,0,0,0.4); color: #ff79c6; padding: 2px 4px; border-radius: 4px; font-size: 0.9em; }
        .markdown-body pre { background: #0d0d12 !important; padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; border: 1px solid #333; }
        .markdown-body pre code { background: transparent; color: #f8f8f2; padding: 0; }
        .markdown-body ul { list-style-type: disc; padding-left: 20px; margin-bottom: 0.5em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 20px; margin-bottom: 0.5em; }
        .markdown-body li { margin-bottom: 2px; }
        
        .katex { font-size: 1.1em !important; color: #e2e8f0; }
        .katex-display { margin: 0.5em 0 !important; overflow-x: auto; overflow-y: hidden; }
        .katex-html { display: inline-block; } 
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col font-sans">

    <header class="h-14 border-b border-gray-800 flex items-center justify-between px-6 bg-cyber-gray/80 backdrop-blur z-50">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-microchip text-cyber-blue text-xl animate-pulse"></i>
            <h1 class="text-xl font-bold tracking-wider text-white font-mono">
                remote-fpga-<span class="text-cyber-blue">comm-lab</span>
                <span class="text-xs text-gray-500 ml-2">v8.0 Official</span>
            </h1>
        </div>
        <div class="flex items-center gap-6 font-mono text-xs">
            <div class="flex items-center gap-2">
                <span class="text-gray-400">CURRENT TARGET:</span>
                <span class="text-cyber-blue font-bold" id="topTargetName">NONE</span>
            </div>
            <div class="flex items-center gap-2 border-l border-gray-700 pl-6">
                <span class="text-gray-400">SIM RATE:</span>
                <span class="text-cyber-blue font-bold">1.0 GSps</span>
            </div>
            <button onclick="location.reload()" class="bg-cyber-blue/10 border border-cyber-blue/50 text-cyber-blue px-3 py-1 rounded hover:bg-cyber-blue/20 transition ml-4">
                <i class="fa-solid fa-power-off mr-1"></i> REBOOT
            </button>
        </div>
    </header>

    <main class="flex-1 flex gap-4 p-4 overflow-hidden relative">
        
        <aside class="w-[20%] flex flex-col gap-4">
            <div class="glass-panel rounded-xl p-4 flex flex-col gap-3 border-l-4 border-cyber-blue">
                <h2 class="text-xs font-bold text-gray-400 font-mono flex justify-between items-center">
                    <span><i class="fa-solid fa-server mr-2"></i>TARGET SELECTION</span>
                    <span class="text-[10px] bg-gray-800 px-1 rounded">2 DEV</span>
                </h2>
                <div id="fpgaList" class="flex flex-col gap-2"></div>
                <button onclick="openUploadModal()" id="btnMainProgram" class="w-full bg-gray-800 border border-gray-600 text-gray-300 py-2 rounded text-xs font-bold transition flex items-center justify-center gap-2 group mt-1">
                    <i class="fa-solid fa-download group-hover:animate-bounce"></i> LOAD BITSTREAM
                </button>
            </div>

            <div class="glass-panel rounded-xl p-5 flex-1 flex flex-col gap-6">
                <h2 class="text-sm font-mono text-gray-400 border-b border-gray-700 pb-2"><i class="fa-solid fa-sliders mr-2"></i>SIGNAL CONTROLS</h2>
                <div class="space-y-1">
                    <label class="text-xs text-cyber-blue font-bold">EXPERIMENT</label>
                    <select id="expSelect" class="w-full bg-black/40 border border-gray-700 text-gray-200 p-2 rounded text-sm focus:border-cyber-blue focus:outline-none font-mono">
                        <option value="SINE" selected>EXP-01: Sine Wave</option>
                        <option value="AM">EXP-02: AM Modulation</option>
                        <option value="FM">EXP-03: FM Modulation</option>
                        <option value="ASK">EXP-04: ASK (OOK)</option>
                        <option value="FSK">EXP-05: 2FSK Keying</option>
                        <option value="QAM">EXP-06: M-QAM</option>
                    </select>
                </div>
                <div class="group">
                    <div class="flex justify-between text-xs font-mono mb-2">
                        <span class="text-gray-300">CARRIER (fc)</span>
                        <span class="text-cyber-blue"><span id="freqVal">20</span> MHz</span>
                    </div>
                    <input type="range" min="5" max="45" value="20" id="freqSlider" class="w-full">
                </div>
                <div class="group" id="ctrl-snr">
                    <div class="flex justify-between text-xs font-mono mb-2">
                        <span class="text-gray-300" id="modFreqLabel">SNR (NOISE)</span>
                        <span class="text-cyber-orange"><span id="noiseVal">25</span> dB</span>
                    </div>
                    <input type="range" min="-5" max="40" value="25" id="noiseSlider" class="w-full">
                </div>
                <div class="group hidden-ctrl" id="ctrl-mod-freq">
                    <div class="flex justify-between text-xs font-mono mb-2">
                        <span class="text-gray-300" id="modFreqLabel">MOD FREQ (fm)</span>
                        <span class="text-purple-400"><span id="modFreqVal">5</span> MHz</span>
                    </div>
                    <input type="range" min="1" max="10" value="5" id="modFreqSlider" class="w-full">
                    <div class="text-[9px] text-gray-500 mt-1" id="modDesc">Controls symbol rate</div>
                </div>
                <div class="group hidden-ctrl" id="ctrl-order">
                    <div class="flex justify-between text-xs font-mono mb-2">
                        <span class="text-gray-300">QAM ORDER</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="order-btn flex-1 py-1 border border-gray-600 rounded text-xs text-gray-400 hover:text-white transition" data-val="4">4</button>
                        <button class="order-btn flex-1 py-1 border border-gray-600 rounded text-xs text-gray-400 hover:text-white transition" data-val="16">16</button>
                        <button class="order-btn flex-1 py-1 border border-gray-600 rounded text-xs text-gray-400 hover:text-white transition" data-val="64">64</button>
                    </div>
                </div>
                <button onclick="resetParams()" class="w-full border border-gray-600 text-gray-400 py-2 rounded text-xs hover:text-white hover:border-white transition mt-2">
                    RESET DEFAULT
                </button>
                <div class="mt-auto pt-4 border-t border-gray-800 flex-1 flex flex-col">
                    <h3 class="text-xs font-mono text-gray-500 mb-2">SYSTEM LOG</h3>
                    <div id="consoleLog" class="flex-1 bg-black/50 rounded border border-gray-800 p-2 font-mono text-[10px] text-green-500/80 overflow-y-auto leading-tight min-h-[100px]"></div>
                </div>
            </div>
        </aside>

        <section class="w-[55%] flex flex-col gap-4">
            <div class="glass-panel rounded-xl flex-1 p-1 relative flex flex-col group overflow-hidden">
                <div class="absolute top-4 left-4 right-4 z-10 flex justify-between items-center pointer-events-none">
                    <h2 class="text-sm font-bold text-gray-400 font-mono tracking-widest bg-black/50 px-2 rounded backdrop-blur">
                        OSCILLOSCOPE <span class="text-cyber-blue text-xs ml-2">CH-A</span>
                    </h2>
                    <div class="flex items-center gap-2 pointer-events-auto bg-black/50 px-2 rounded backdrop-blur">
                        <div id="trigLed" class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div>
                        <span class="text-[10px] font-mono text-gray-400">TRIG</span>
                    </div>
                </div>
                <div id="scopeOverlay" class="absolute inset-0 bg-black/80 z-20 flex flex-col items-center justify-center hidden">
                    <i class="fa-solid fa-triangle-exclamation text-4xl text-yellow-500 mb-2"></i>
                    <div class="text-gray-300 font-mono text-sm mt-2" id="overlayText">NO SIGNAL</div>
                </div>
                <div id="scopeChart" class="w-full h-full z-0"></div>
            </div>

            <div class="glass-panel rounded-xl h-36 p-4 flex gap-4 items-center justify-between bg-black/40">
                <div class="flex flex-col items-center gap-2 w-1/4">
                    <div class="text-[10px] font-bold text-gray-500 border-b border-gray-700 w-full text-center pb-1">VERTICAL (Y)</div>
                    <div class="flex gap-4 w-full">
                        <div class="flex-1"><input type="range" id="vPos" min="-5" max="5" step="0.1" value="0" class="w-full"><div class="knob-label">POS</div></div>
                        <div class="flex-1"><input type="range" id="vScale" min="0.5" max="5" step="0.1" value="1" class="w-full"><div class="knob-label">VOLT</div></div>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2 w-1/4">
                    <div class="text-[10px] font-bold text-gray-500 border-b border-gray-700 w-full text-center pb-1">HORIZONTAL (X)</div>
                    <div class="flex gap-4 w-full">
                        <div class="flex-1"><input type="range" id="hPos" min="0" max="2000" step="10" value="0" class="w-full"><div class="knob-label">POS</div></div>
                        <div class="flex-1"><input type="range" id="hScale" min="100" max="2048" step="10" value="1024" class="w-full" style="direction: rtl"><div class="knob-label">TIME</div></div>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2 w-1/4 border-l border-gray-700 pl-4 border-r pr-4">
                    <div class="text-[10px] font-bold text-gray-500 w-full text-center pb-1">TRIGGER</div>
                    <div class="flex w-full gap-3 items-center">
                        <div class="flex-1 text-center">
                            <input type="range" id="trigSlider" min="-3" max="3" step="0.1" value="0" class="w-full">
                            <div class="knob-label text-cyber-yellow">LVL <span id="trigValText">0.0V</span></div>
                        </div>
                        <button id="btnTrigger" onclick="toggleTrigger()" class="w-16 py-2 border border-gray-600 text-gray-400 rounded hover:border-cyber-green hover:text-cyber-green transition text-xs font-mono">
                            <span id="trigText">AUTO</span>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-2 w-1/6">
                    <button onclick="togglePause()" id="pauseBtn" class="w-full py-1 bg-gray-800 border border-gray-600 text-gray-300 hover:text-white hover:border-white rounded flex items-center justify-center gap-2 text-xs transition"><i class="fa-solid fa-pause"></i> PAUSE</button>
                    <button onclick="clearBuffer()" class="w-full py-1 bg-gray-800 border border-gray-600 text-gray-300 hover:text-red-400 hover:border-red-400 rounded flex items-center justify-center gap-2 text-xs transition"><i class="fa-solid fa-trash"></i> CLEAR</button>
                </div>
            </div>
        </section>

        <aside class="w-[25%] flex flex-col gap-4">
            <div class="glass-panel rounded-xl w-full aspect-square p-2 relative flex flex-col items-center justify-center bg-black/20 mx-auto">
                <div class="absolute top-3 left-4 z-10 pointer-events-none"><h2 class="text-xs font-bold text-gray-400 font-mono">CONSTELLATION</h2></div>
                <div id="constellationChart" class="w-full h-full"></div>
            </div>
            <div class="glass-panel rounded-xl flex-1 p-2 relative flex flex-col">
                <div class="absolute top-2 left-4 z-10 pointer-events-none"><h2 class="text-xs font-bold text-gray-400 font-mono">SPECTRUM (0-50MHz)</h2></div>
                <div id="fftChart" class="w-full h-full"></div>
            </div>
        </aside>

        <div id="uploadModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
            <div class="glass-modal w-96 rounded-xl p-6 flex flex-col gap-4 animate-bounce-in">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3">
                    <h2 class="text-lg font-bold text-white font-mono"><i class="fa-solid fa-file-circuit mr-2 text-cyber-blue"></i>LOAD BITSTREAM</h2>
                    <button onclick="closeUploadModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="bg-black/50 border border-gray-700 border-dashed rounded-lg p-6 text-center cursor-pointer hover:border-cyber-blue transition group">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-600 group-hover:text-cyber-blue mb-2 transition"></i>
                    <div class="text-xs text-gray-400">Click to select .bit / .bin file</div>
                    <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">
                </div>
                <div class="flex justify-between items-center text-xs font-mono">
                    <span class="text-gray-400">TARGET:</span>
                    <span id="modalTargetName" class="text-cyber-blue">NONE</span>
                </div>
                <div id="fileName" class="text-xs text-cyber-green font-mono hidden">Selected: firmware_v4.bit</div>
                <div id="progressContainer" class="hidden space-y-1">
                    <div class="flex justify-between text-[10px] text-gray-400 font-mono">
                        <span>PROGRAMMING...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-cyber-blue w-0 progress-bar"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <button onclick="closeUploadModal()" class="py-2 border border-gray-600 text-gray-400 rounded text-xs hover:text-white">CANCEL</button>
                    <button onclick="startProgramming()" id="btnProgram" class="py-2 bg-cyber-blue text-black font-bold rounded text-xs opacity-50 cursor-not-allowed" disabled>FLASH</button>
                </div>
            </div>
        </div>

        <div id="aiFab" onclick="toggleAiChat()" class="fixed bottom-6 left-6 w-12 h-12 rounded-full bg-cyber-purple/20 border border-cyber-purple text-cyber-purple flex items-center justify-center cursor-pointer hover:bg-cyber-purple hover:text-white hover:scale-110 transition z-40 animate-float shadow-[0_0_15px_rgba(188,19,254,0.4)]">
            <i class="fa-solid fa-robot text-xl"></i>
        </div>

        <div id="aiChatWindow" class="fixed bottom-20 left-6 w-[500px] h-[600px] glass-modal rounded-xl flex flex-col hidden z-50 transform transition-all origin-bottom-left">
            <div class="h-10 border-b border-gray-700 flex items-center justify-between px-4 bg-cyber-purple/10 rounded-t-xl">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-brain text-cyber-purple text-xs"></i>
                    <span class="text-xs font-bold text-white font-mono">AI TEACHING ASSISTANT</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleAiConfig()" class="text-gray-400 hover:text-white text-xs"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="toggleAiChat()" class="text-gray-400 hover:text-white text-xs"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
            </div>
            
            <div id="aiConfigPanel" class="hidden bg-gray-900 p-3 border-b border-gray-700">
                <div class="text-[10px] text-gray-400 mb-1">DEEPSEEK API KEY</div>
                <input type="password" id="apiKeyInput" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-2" placeholder="sk-...">
                <div class="text-[10px] text-gray-400 mb-1">API URL</div>
                <input type="text" id="apiUrlInput" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-2" value="https://api.deepseek.com/chat/completions">
                <div class="text-[10px] text-gray-400 mb-1">MODEL NAME</div>
                <input type="text" id="apiModelInput" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-2" value="deepseek-chat">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="resetDeepSeek()" class="bg-gray-700 text-gray-300 text-xs py-1 rounded hover:bg-gray-600">RESET DEFAULTS</button>
                    <button onclick="saveAiConfig()" class="bg-cyber-purple text-white text-xs py-1 rounded">SAVE SETTINGS</button>
                </div>
            </div>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-3 flex flex-col gap-3 text-xs font-mono scrollbar-thin">
                <div class="ai-msg p-2 max-w-[85%]">
                    ðŸ‘‹ <strong>Welcome to the Digital Communication Lab!</strong><br><br>
                    I am your AI Teaching Assistant. I can help you with:<br>
                    â€¢ Signal Modulation Theory (AM/FM/QAM)<br>
                    â€¢ Spectrum Analysis (FFT)<br>
                    â€¢ FPGA Debugging & Configuration<br><br>
                    <span class="text-gray-400 text-[10px]">ðŸ’¡ Tip: Click <i class="fa-solid fa-gear"></i> to configure your API Key.</span>
                </div>
            </div>
            
            <div class="h-12 border-t border-gray-700 p-2 flex gap-2">
                <input type="text" id="aiInput" placeholder="Ask AI Assistant..." class="flex-1 bg-black/50 border border-gray-600 rounded px-2 text-xs text-white focus:border-cyber-purple focus:outline-none" onkeypress="if(event.key==='Enter') sendAiMessage()">
                <button onclick="sendAiMessage()" class="w-8 bg-cyber-purple/20 border border-cyber-purple text-cyber-purple rounded hover:bg-cyber-purple hover:text-white transition"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>

    </main>

    <script>
        // ================= å…¨å±€çŠ¶æ€ =================
        const state = {
            experiment: 'SINE', freq: 12, modFreq: 2, modOrder: 16, noise: 25,
            triggerMode: false, triggerLevel: 0.0, 
            vOffset: 0, vScale: 1, hOffset: 0, hWindow: 1024,
            isPaused: false,
            fpgas: [
                { id: 1, name: 'FPGA-01 (Z7020)', status: 'IDLE', ip: '192.168.1.10' },
                { id: 2, name: 'FPGA-02 (Z7020)', status: 'BUSY', ip: '192.168.1.11' }
            ],
            targetFpga: 1, isProgramming: false, lastTriggerIndex: 0 
        };

        // ================= ECharts Init =================
        const scopeChart = echarts.init(document.getElementById('scopeChart'));
        scopeChart.setOption({
            grid: { top: 30, bottom: 20, left: 40, right: 10, borderColor: '#444', show: true, backgroundColor: 'rgba(0,0,0,0.2)' },
            xAxis: { type: 'value', min: 0, max: 1024, show: false, boundaryGap: false },
            yAxis: { type: 'value', min: -3, max: 3, splitLine: { lineStyle: { color: '#444', type: 'dashed', width: 0.5 } }, axisLabel: { color: '#888', fontFamily: 'monospace', fontSize: 10 } },
            series: [{ type: 'line', smooth: false, showSymbol: false, sampling: null, lineStyle: { color: '#00f3ff', width: 1.5 }, data: [], markLine: { symbol: ['none', 'none'], label: { show: false }, lineStyle: { color: '#ffd700', type: 'dashed', width: 1 }, data: [{ yAxis: 0 }] } }], animation: false
        });
        const constChart = echarts.init(document.getElementById('constellationChart'));
        constChart.setOption({
            grid: { top: 30, bottom: 30, left: 30, right: 30 },
            xAxis: { min: -2.5, max: 2.5, splitLine: { show: true, lineStyle:{color:'#333'} }, axisLine: {show: false}, axisLabel: {show:false} },
            yAxis: { min: -2.5, max: 2.5, splitLine: { show: true, lineStyle:{color:'#333'} }, axisLine: {show: false}, axisLabel: {show:false} },
            series: [{ type: 'scatter', symbolSize: 3, itemStyle: { color: '#ffaa00', opacity: 0.6 }, data: [] }], animation: false
        });
        const fftChart = echarts.init(document.getElementById('fftChart'));
        fftChart.setOption({
            grid: { top: 25, bottom: 20, left: 35, right: 10 },
            xAxis: { type: 'category', show: true, boundaryGap: false, data: Array.from({length: 1024}, (_, i) => (i % 128 === 0) ? (i * (50/1024)).toFixed(0) + 'M' : ''), axisLine: {show: true, lineStyle: {color: '#333'}}, axisLabel: { fontSize: 8, color: '#666', interval: 0 }, axisTick: { alignWithLabel: true, interval: 128 } },
            yAxis: { type: 'value', show: true, min: -100, max: 10, axisLabel: { formatter: '{value} dB', fontSize: 8, color: '#666' }, splitLine: { lineStyle: { color: '#333', type: 'dashed' } } },
            series: [{ type: 'line', symbol: 'none', smooth: false, sampling: null, lineStyle: { color: '#00ff41', width: 1 }, areaStyle: null, data: [] }], animation: false
        });

        // ================= UI ç»‘å®š =================
        const els = {
            fpgaList: document.getElementById('fpgaList'), btnMainProgram: document.getElementById('btnMainProgram'),
            topTargetName: document.getElementById('topTargetName'), scopeOverlay: document.getElementById('scopeOverlay'), overlayText: document.getElementById('overlayText'),
            trigSlider: document.getElementById('trigSlider'), trigValText: document.getElementById('trigValText'), 
            logBox: document.getElementById('consoleLog'), freqSlider: document.getElementById('freqSlider'), modFreqSlider: document.getElementById('modFreqSlider'), noiseSlider: document.getElementById('noiseSlider'),
            freqVal: document.getElementById('freqVal'), modFreqVal: document.getElementById('modFreqVal'), noiseVal: document.getElementById('noiseVal'),
            expSelect: document.getElementById('expSelect'), ctrlModFreq: document.getElementById('ctrl-mod-freq'), ctrlOrder: document.getElementById('ctrl-order'),
            modFreqLabel: document.getElementById('modFreqLabel'), modDesc: document.getElementById('modDesc'),
            vPos: document.getElementById('vPos'), vScale: document.getElementById('vScale'), hPos: document.getElementById('hPos'), hScale: document.getElementById('hScale'),
            btnTrigger: document.getElementById('btnTrigger'), trigText: document.getElementById('trigText'), trigLed: document.getElementById('trigLed'), pauseBtn: document.getElementById('pauseBtn'),
            // AI
            aiChatWindow: document.getElementById('aiChatWindow'), aiInput: document.getElementById('aiInput'), chatMessages: document.getElementById('chatMessages'),
            aiConfigPanel: document.getElementById('aiConfigPanel'), apiKeyInput: document.getElementById('apiKeyInput'), apiUrlInput: document.getElementById('apiUrlInput'), apiModelInput: document.getElementById('apiModelInput')
        };

        // ================= AI Chat Logic (Complete & Fixed) =================
        let msgCounter = 0; 
        marked.use({ breaks: true, gfm: true });

        function resetDeepSeek() {
            els.apiUrlInput.value = "https://api.deepseek.com/chat/completions";
            els.apiModelInput.value = "deepseek-chat";
            saveAiConfig();
            alert("Settings reset to DeepSeek defaults!");
        }

        function initAiConfig() {
            const savedKey = localStorage.getItem('fpga_lab_api_key');
            const savedUrl = localStorage.getItem('fpga_lab_api_url');
            const savedModel = localStorage.getItem('fpga_lab_api_model');
            if(savedKey) els.apiKeyInput.value = savedKey;
            
            if(!savedUrl || savedUrl.includes("openai.com")) els.apiUrlInput.value = "https://api.deepseek.com/chat/completions";
            else els.apiUrlInput.value = savedUrl;

            if(!savedModel || savedModel.includes("gpt")) els.apiModelInput.value = "deepseek-chat";
            else els.apiModelInput.value = savedModel;
        }
        initAiConfig();

        function toggleAiChat() { els.aiChatWindow.classList.toggle('hidden'); }
        function toggleAiConfig() { els.aiConfigPanel.classList.toggle('hidden'); }
        function saveAiConfig() {
            localStorage.setItem('fpga_lab_api_key', els.apiKeyInput.value);
            localStorage.setItem('fpga_lab_api_url', els.apiUrlInput.value);
            localStorage.setItem('fpga_lab_api_model', els.apiModelInput.value);
            toggleAiConfig();
            appendChatMsg('ai', 'Settings saved.');
        }

        async function sendAiMessage() {
            const msg = els.aiInput.value.trim();
            if(!msg) return;
            const apiKey = els.apiKeyInput.value;
            if(!apiKey) { toggleAiConfig(); return alert("Please enter your DeepSeek API Key!"); }

            appendChatMsg('user', msg);
            els.aiInput.value = '';
            const loadingId = appendChatMsg('ai', '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>');
            
            try {
                const systemPrompt = `You are a helper for an FPGA Lab. Status: Exp=${state.experiment}, Freq=${state.freq}MHz, SNR=${state.noise}dB. Be concise. Use standard LaTeX for math, e.g. $E=mc^2$ or $$x^2$$.`;
                
                const response = await fetch(els.apiUrlInput.value, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: els.apiModelInput.value, 
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: msg }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                let aiReply = "Error: No response.";
                
                if (data.choices && data.choices.length > 0) {
                    aiReply = data.choices[0].message.content;
                } else if (data.error) {
                    if(data.error.code === 'model_not_found' || data.error.message.includes('model')) {
                        aiReply = `API Error: Model Not Found. <br><button onclick="resetDeepSeek()" style="text-decoration:underline; color:#00f3ff; cursor:pointer;">Click here to fix settings</button>`;
                    } else {
                        aiReply = "API Error: " + data.error.message;
                    }
                }

                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
                
                // Formula Protection & Rendering
                let protectedText = aiReply;
                const mathSegments = [];
                protectedText = protectedText.replace(/\$\$([\s\S]+?)\$\$/g, (m) => { mathSegments.push(m); return `%%%MATH_BLOCK_${mathSegments.length-1}%%%`; });
                protectedText = protectedText.replace(/\\\[([\s\S]+?)\\\]/g, (m) => { mathSegments.push(m); return `%%%MATH_BLOCK_${mathSegments.length-1}%%%`; });
                protectedText = protectedText.replace(/\\\(([\s\S]+?)\\\)/g, (m) => { mathSegments.push(m); return `%%%MATH_INLINE_${mathSegments.length-1}%%%`; });
                protectedText = protectedText.replace(/(?<!\\)\$([^\n$]+?)(?<!\\)\$/g, (m) => { mathSegments.push(m); return `%%%MATH_INLINE_${mathSegments.length-1}%%%`; });

                let finalHtml = marked.parse(protectedText);
                finalHtml = finalHtml.replace(/%%%MATH_(BLOCK|INLINE)_(\d+)%%%/g, (m, t, id) => mathSegments[id]);

                const msgId = appendChatMsg('ai', `<div class="markdown-body">${finalHtml}</div>`);
                renderMathInElement(document.getElementById(msgId), {
                    delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ],
                    throwOnError: false
                });

            } catch (error) {
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
                appendChatMsg('ai', `<span style="color:#ff2a2a">Network Error: ${error.message}</span>`);
            }
        }

        function appendChatMsg(role, html) {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'user-msg p-2 max-w-[85%]' : 'ai-msg p-2 max-w-[85%]';
            div.innerHTML = html;
            div.id = 'msg-' + Date.now() + '-' + (msgCounter++); 
            els.chatMessages.appendChild(div);
            els.chatMessages.scrollTop = els.chatMessages.scrollHeight;
            return div.id;
        }

        // ================= å…¶ä½™é€»è¾‘ =================
        function renderFpgaList() {
            els.fpgaList.innerHTML = ''; let targetObj = null;
            state.fpgas.forEach(fpga => {
                const isSelected = (fpga.id === state.targetFpga); if(isSelected) targetObj = fpga;
                let statusColor = fpga.status === 'IDLE' ? 'bg-cyber-green shadow-[0_0_8px_#00ff41]' : (fpga.status === 'BUSY' ? 'bg-cyber-red shadow-[0_0_8px_#ff2a2a]' : 'bg-cyber-orange animate-pulse');
                const div = document.createElement('div');
                div.className = `border rounded p-2 cursor-pointer transition flex justify-between items-center bg-black/40 hover:border-gray-500 fpga-card ${isSelected ? 'fpga-card-selected' : 'border-gray-700'}`;
                div.innerHTML = `<div class="flex flex-col"><span class="text-xs font-bold text-gray-200 font-mono">${fpga.name}</span><span class="text-[9px] text-gray-500 font-mono">${fpga.ip}</span></div><div class="flex items-center gap-2"><span class="text-[9px] font-bold text-gray-400">${fpga.status}</span><div class="w-2 h-2 rounded-full ${statusColor}"></div></div>`;
                div.onclick = () => selectFpga(fpga.id); els.fpgaList.appendChild(div);
            });
            if(targetObj) {
                els.topTargetName.innerText = targetObj.name; document.getElementById('modalTargetName').innerText = targetObj.name;
                if(targetObj.status !== 'IDLE') { els.btnMainProgram.disabled = true; els.btnMainProgram.classList.add('opacity-50', 'cursor-not-allowed'); els.btnMainProgram.classList.remove('btn-glow'); els.scopeOverlay.classList.remove('hidden'); els.overlayText.innerText = `TARGET IS ${targetObj.status}`; } 
                else { els.btnMainProgram.disabled = false; els.btnMainProgram.classList.remove('opacity-50', 'cursor-not-allowed'); els.btnMainProgram.classList.add('btn-glow'); if(!state.isProgramming) els.scopeOverlay.classList.add('hidden'); }
            }
        }
        function selectFpga(id) { state.targetFpga = id; renderFpgaList(); logSystem(`Target switched to FPGA-0${id}`); clearBuffer(); }

        const modal = { el: document.getElementById('uploadModal'), fileInput: document.getElementById('fileInput'), fileName: document.getElementById('fileName'), btn: document.getElementById('btnProgram'), progress: document.getElementById('progressContainer'), bar: document.getElementById('progressBar'), text: document.getElementById('progressText') };
        function openUploadModal() { const target = state.fpgas.find(f => f.id === state.targetFpga); if(target.status !== 'IDLE') return; modal.el.classList.remove('hidden'); }
        function closeUploadModal() { modal.el.classList.add('hidden'); resetModalUI(); }
        document.querySelector('.bg-black\\/50').onclick = () => modal.fileInput.click();
        function handleFileSelect(input) { if(input.files.length > 0) { modal.fileName.innerText = "Selected: " + input.files[0].name; modal.fileName.classList.remove('hidden'); modal.btn.disabled = false; modal.btn.classList.remove('opacity-50', 'cursor-not-allowed'); modal.btn.classList.add('btn-glow'); } }
        function resetModalUI() { modal.fileName.classList.add('hidden'); modal.progress.classList.add('hidden'); modal.bar.style.width = '0%'; modal.btn.disabled = true; modal.btn.classList.add('opacity-50', 'cursor-not-allowed'); modal.btn.classList.remove('btn-glow'); modal.fileInput.value = ''; }
        function startProgramming() { if(state.isProgramming) return; const targetIdx = state.fpgas.findIndex(f => f.id === state.targetFpga); state.fpgas[targetIdx].status = 'FLASH'; renderFpgaList(); state.isProgramming = true; modal.progress.classList.remove('hidden'); modal.btn.disabled = true; els.scopeOverlay.classList.remove('hidden'); els.overlayText.innerText = "FLASHING BITSTREAM..."; logSystem(`JTAG: Programming ${state.fpgas[targetIdx].name}...`); let p = 0; const timer = setInterval(() => { p += Math.random() * 5; if(p >= 100) { p = 100; clearInterval(timer); finishProgramming(targetIdx); } modal.bar.style.width = p + '%'; modal.text.innerText = Math.floor(p) + '%'; }, 80); }
        function finishProgramming(targetIdx) { setTimeout(() => { logSystem("JTAG: Configuration Complete."); state.fpgas[targetIdx].status = 'IDLE'; state.isProgramming = false; renderFpgaList(); els.scopeOverlay.classList.add('hidden'); closeUploadModal(); clearBuffer(); }, 500); }

        const SIM_SAMPLERATE = 1000.0; const BUFFER_SIZE = 4096;
        let persistentBuffer = new Float32Array(BUFFER_SIZE);
        let lastConstellation = [], lastFFT = [];

        function performCalibratedDFT(buffer) {
            const numBins = 1024; let spectrum = new Array(numBins).fill(-100);
            const N = 2048; let windowed = new Float32Array(N);
            for(let i=0; i<N; i++) { const a0=0.42, a1=0.5, a2=0.08; const win = a0 - a1*Math.cos(2*Math.PI*i/(N-1)) + a2*Math.cos(4*Math.PI*i/(N-1)); windowed[i] = buffer[i] * win; }
            for (let k = 0; k < numBins; k++) { const freq = k * (50.0 / (numBins-1)); const omega = 2 * Math.PI * freq / SIM_SAMPLERATE; let r = 0, i = 0; for (let n = 0; n < N; n++) { r += windowed[n] * Math.cos(omega * n); i += windowed[n] * Math.sin(omega * n); } let mag = Math.sqrt(r*r + i*i) * 4.0 / N; spectrum[k] = Math.max(-100, 20 * Math.log10(mag + 1e-9)); }
            if (spectrum[0] > spectrum[1]) spectrum[0] = spectrum[1]; return spectrum;
        }

        function findTriggerIndex(data, level, slope='rising') {
            const searchWindow = 1000; for (let i = 1; i < searchWindow; i++) { if (slope === 'rising') { if (data[i-1] < level && data[i] >= level) return i; } } return -1; 
        }

        function generateData() {
            const currentFpga = state.fpgas.find(f => f.id === state.targetFpga);
            if (!currentFpga || currentFpga.status !== 'IDLE' || state.isProgramming) return null;
            if (state.isPaused) {
                let displayWave = []; let startIndex = state.lastTriggerIndex + parseInt(state.hOffset); 
                const safeEnd = Math.min(startIndex + parseInt(state.hWindow), BUFFER_SIZE);
                for (let i = startIndex; i < safeEnd; i++) displayWave.push([i - startIndex, persistentBuffer[i]]);
                return { wave: displayWave, constellation: lastConstellation, fft: lastFFT };
            }
            const timeOffset = new Date().getTime() / 1000;
            const noiseAmp = Math.pow(10, -state.noise/20); 
            let rawBuffer = new Float32Array(BUFFER_SIZE);
            let constData = [];
            for (let i = 0; i < BUFFER_SIZE; i++) {
                const t = i / 1000.0; const continuousT = t + timeOffset; let val = 0;
                const wc = 2 * Math.PI * state.freq; const wm = 2 * Math.PI * state.modFreq; 
                switch (state.experiment) {
                    case 'SINE': val = Math.sin(wc * continuousT); break;
                    case 'AM': val = (1 + 0.7 * Math.sin(wm * continuousT)) * Math.sin(wc * continuousT); break;
                    case 'FM': val = Math.sin(wc * continuousT + 5.0 * Math.sin(wm * continuousT)); break;
                    case 'ASK': val = (Math.sin(wm * continuousT) > 0 ? 1 : 0) * Math.sin(wc * continuousT); break;
                    case 'FSK': val = Math.sin(2 * Math.PI * ((Math.sin(wm * continuousT) > 0 ? 1 : 0) === 0 ? state.freq : state.freq * 2.0) * continuousT); break;
                    case 'QAM': const M = state.modOrder; const samplesPerSymbol = 1000 / state.modFreq; const symbolIdx = Math.floor((i + timeOffset*1000*1000) / samplesPerSymbol); const seed = symbolIdx; const rand1 = Math.abs(Math.sin(seed)); const rand2 = Math.abs(Math.cos(seed)); const normAmp = (0.5 + (rand1 * (Math.sqrt(M)/2))) / (Math.sqrt(M)/1.5); val = normAmp * Math.sin(wc * continuousT + (Math.floor(rand2 * 4)) * (Math.PI / 2)); break;
                }
                rawBuffer[i] = val + (Math.random() - 0.5) * noiseAmp * 2.0;
            }
            if (state.experiment === 'QAM') { const M = state.modOrder; const sqrtM = Math.sqrt(M); let centers = []; for (let i = 0; i < sqrtM; i++) { for (let j = 0; j < sqrtM; j++) { let x = (i * 2 - (sqrtM - 1)); let y = (j * 2 - (sqrtM - 1)); let scale = 1.8 / (sqrtM - 1 || 1); if (M === 4) scale = 1.0; centers.push([x * scale, y * scale]); } } const pointsToDraw = (M === 64) ? 250 : 150; for(let k=0; k < pointsToDraw; k++) { const center = centers[Math.floor(Math.random() * centers.length)]; constData.push([center[0] + (Math.random()-0.5) * noiseAmp * 1.5, center[1] + (Math.random()-0.5) * noiseAmp * 1.5]); } } else if (state.experiment === 'ASK') { for(let k=0; k<100; k++) { if(Math.random() > 0.5) constData.push([(Math.random()-0.5)*noiseAmp, (Math.random()-0.5)*noiseAmp]); else constData.push([1.0 + (Math.random()-0.5)*noiseAmp, (Math.random()-0.5)*noiseAmp]); } } else if (state.experiment === 'SINE' || state.experiment === 'FM' || state.experiment === 'FSK') { for(let k=0; k<150; k++) { const a = Math.random() * Math.PI * 2; const r = 1.0 + (Math.random()-0.5) * noiseAmp; constData.push([r * Math.cos(a), r * Math.sin(a)]); } } else { for(let k=0; k<120; k++) constData.push([Math.random() * 0.5 + 0.2 + (Math.random()-0.5)*noiseAmp, (Math.random()-0.5)*noiseAmp]); }
            const triggerIdx = findTriggerIndex(rawBuffer, state.triggerLevel, 'rising');
            let displayStartIndex = 0; let shouldUpdateWaveform = true; 
            if (state.triggerMode) {
                if (triggerIdx !== -1) { displayStartIndex = triggerIdx; state.lastTriggerIndex = triggerIdx; persistentBuffer = rawBuffer; lastFFT = performCalibratedDFT(rawBuffer); lastConstellation = constData; els.trigLed.classList.add('bg-cyber-green', 'shadow-neon'); els.trigLed.classList.remove('bg-gray-600'); } 
                else { shouldUpdateWaveform = false; els.trigLed.classList.remove('bg-cyber-green', 'shadow-neon'); els.trigLed.classList.add('bg-gray-600'); }
            } else {
                persistentBuffer = rawBuffer; lastFFT = performCalibratedDFT(rawBuffer); lastConstellation = constData;
                if (triggerIdx !== -1) { displayStartIndex = triggerIdx; els.trigLed.classList.add('bg-cyber-green', 'shadow-neon'); els.trigLed.classList.remove('bg-gray-600'); } 
                else { displayStartIndex = 0; els.trigLed.classList.remove('bg-cyber-green', 'shadow-neon'); els.trigLed.classList.add('bg-gray-600'); }
                state.lastTriggerIndex = displayStartIndex;
            }
            if (shouldUpdateWaveform || !state.triggerMode) {
                let displayWave = []; displayStartIndex += parseInt(state.hOffset); const safeEnd = Math.min(displayStartIndex + parseInt(state.hWindow), BUFFER_SIZE);
                for (let i = displayStartIndex; i < safeEnd; i++) displayWave.push([i - displayStartIndex, persistentBuffer[i]]);
                return { wave: displayWave, constellation: lastConstellation, fft: lastFFT };
            } else return null; 
        }

        function logSystem(msg) { const t = new Date().toLocaleTimeString(); els.logBox.innerHTML += `<div><span class="text-gray-500">[${t}]</span> ${msg}</div>`; els.logBox.scrollTop = els.logBox.scrollHeight; }
        function clearBuffer() { persistentBuffer.fill(0); lastConstellation = []; lastFFT = []; scopeChart.setOption({ series: [{ data: [] }] }); logSystem("Buffer Cleared"); }
        function togglePause() { state.isPaused = !state.isPaused; if(state.isPaused) { els.pauseBtn.classList.add('bg-cyber-blue', 'text-black'); logSystem("Paused"); } else { els.pauseBtn.classList.remove('bg-cyber-blue', 'text-black'); logSystem("Resumed"); } }
        function toggleTrigger() { state.triggerMode = !state.triggerMode; if(state.triggerMode) { els.btnTrigger.classList.add('border-cyber-green', 'text-cyber-green'); els.trigText.innerText = "NORMAL"; logSystem("Trigger: LOCKED (Normal)"); } else { els.btnTrigger.classList.remove('border-cyber-green', 'text-cyber-green'); els.trigText.innerText = "AUTO"; logSystem("Trigger: AUTO"); } }
        els.trigSlider.addEventListener('input', (e) => { state.triggerLevel = parseFloat(e.target.value); els.trigValText.innerText = state.triggerLevel.toFixed(1) + 'V'; scopeChart.setOption({ series: [{ markLine: { data: [{ yAxis: state.triggerLevel }] } }] }); });
        els.vPos.addEventListener('input', (e) => { state.vOffset = e.target.value; scopeChart.setOption({ yAxis: { min: state.vOffset - 3/state.vScale, max: parseFloat(state.vOffset) + 3/state.vScale } }); });
        els.vScale.addEventListener('input', (e) => { state.vScale = e.target.value; scopeChart.setOption({ yAxis: { min: state.vOffset - 3/state.vScale, max: parseFloat(state.vOffset) + 3/state.vScale } }); });
        els.hPos.addEventListener('input', (e) => { state.hOffset = e.target.value; });
        els.hScale.addEventListener('input', (e) => { state.hWindow = parseInt(e.target.value); scopeChart.setOption({ xAxis: { max: state.hWindow } }); });
        els.expSelect.addEventListener('change', (e) => { state.experiment = e.target.value; updateUI(); });
        els.freqSlider.addEventListener('input', (e) => { state.freq = parseInt(e.target.value); els.freqVal.innerText = state.freq; });
        els.modFreqSlider.addEventListener('input', (e) => { state.modFreq = parseInt(e.target.value); els.modFreqVal.innerText = state.modFreq; });
        els.noiseSlider.addEventListener('input', (e) => { state.noise = parseInt(e.target.value); els.noiseVal.innerText = state.noise; });
        function updateUI() { const ex = state.experiment; els.ctrlModFreq.classList.add('hidden-ctrl'); els.ctrlOrder.classList.add('hidden-ctrl'); if (ex === 'AM' || ex === 'FM') { els.ctrlModFreq.classList.remove('hidden-ctrl'); els.modFreqLabel.innerText = "MOD FREQ (fm)"; } else if (ex === 'ASK' || ex === 'FSK' || ex === 'QAM') { els.ctrlModFreq.classList.remove('hidden-ctrl'); els.modFreqLabel.innerText = "SYMBOL RATE"; if(ex === 'QAM') els.ctrlOrder.classList.remove('hidden-ctrl'); } clearBuffer(); logSystem(`Switch: ${ex}`); }
        function resetParams() { state.freq = 12; state.noise = 25; state.modFreq = 5; state.modOrder = 16; els.freqSlider.value = 12; els.noiseSlider.value = 25; els.modFreqSlider.value = 5; els.freqVal.innerText = 12; els.noiseVal.innerText = 25; els.modFreqVal.innerText = 5; document.querySelector('.order-btn[data-val="16"]').click(); updateUI(); }
        document.querySelectorAll('.order-btn').forEach(btn => { btn.addEventListener('click', (e) => { state.modOrder = parseInt(e.target.dataset.val); document.querySelectorAll('.order-btn').forEach(b => { b.classList.remove('bg-cyber-blue/20', 'text-cyber-blue', 'border-cyber-blue'); b.classList.add('text-gray-400', 'border-gray-600'); }); e.target.classList.remove('text-gray-400', 'border-gray-600'); e.target.classList.add('bg-cyber-blue/20', 'text-cyber-blue', 'border-cyber-blue'); logSystem(`QAM Order Set: ${state.modOrder}`); }); });

        renderFpgaList();
        setInterval(() => { const data = generateData(); if(!data) return; scopeChart.setOption({ series: [{ data: data.wave }] }); constChart.setOption({ series: [{ data: data.constellation }] }); fftChart.setOption({ series: [{ data: data.fft }] }); }, 60);
        window.addEventListener('resize', () => { scopeChart.resize(); constChart.resize(); fftChart.resize(); });
        updateUI(); document.querySelector('.order-btn[data-val="16"]').click(); logSystem("System v8.0 Online"); scopeChart.setOption({ xAxis: { max: state.hWindow } }); 
    </script>
</body>
</html>